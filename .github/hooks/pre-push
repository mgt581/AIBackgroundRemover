#!/bin/bash
# Pre-push hook to check if branch is in sync with remote
# Place this in .git/hooks/pre-push and make it executable

remote="$1"
url="$2"

# Get the current branch name
current_branch=$(git symbolic-ref --short HEAD)

echo "Checking if $current_branch is in sync with remote..."

# Fetch the latest changes from remote
git fetch origin "$current_branch" 2>/dev/null

# Check if remote branch exists
if git show-ref --verify --quiet "refs/remotes/origin/$current_branch"; then
    # Count commits ahead and behind
    behind=$(git rev-list --count HEAD..origin/"$current_branch" 2>/dev/null)
    ahead=$(git rev-list --count origin/"$current_branch"..HEAD 2>/dev/null)
    
    if [ "$behind" -gt 0 ]; then
        echo "❌ ERROR: Your branch is $behind commits behind origin/$current_branch"
        echo ""
        echo "Please update your branch first:"
        echo "  git fetch origin"
        echo "  git pull --rebase origin $current_branch"
        echo ""
        echo "Or merge the changes:"
        echo "  git fetch origin"
        echo "  git merge origin/$current_branch"
        echo ""
        exit 1
    fi
    
    echo "✅ Branch is in sync with remote ($ahead commits ahead)"
else
    echo "ℹ️  Remote branch does not exist. This appears to be a new branch."
fi

# Check if pushing to protected branches
if [ "$current_branch" = "main" ] || [ "$current_branch" = "master" ]; then
    echo "⚠️  WARNING: You are pushing to $current_branch branch!"
    
    # Check if we're in a non-interactive environment
    # This includes CI/CD, scripts, or when SKIP_PUSH_CONFIRM is set
    if [ -n "$CI" ] || [ -n "$GITHUB_ACTIONS" ] || [ -n "$SKIP_PUSH_CONFIRM" ] || [ ! -t 0 ]; then
        echo "ℹ️  Non-interactive environment detected - auto-approving push"
        echo "   (Set SKIP_PUSH_CONFIRM=1 or use --no-verify to bypass this check)"
    else
        echo "Are you sure you want to continue? (y/n)"
        read -r response
        if [ "$response" != "y" ]; then
            echo "Push cancelled."
            exit 1
        fi
    fi
fi

echo "✅ Pre-push checks passed"
exit 0
