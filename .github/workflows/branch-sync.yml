name: Branch Sync Check

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - main
      - develop

jobs:
  check-sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Fetch all branches
      run: |
        git fetch --all --tags --prune
        
    - name: Check if branch is ahead of remote
      if: github.event_name == 'push'
      run: |
        BRANCH_NAME=${GITHUB_REF#refs/heads/}
        echo "Checking branch: $BRANCH_NAME"
        
        # Get remote tracking branch
        REMOTE_BRANCH="origin/$BRANCH_NAME"
        
        # Check if remote branch exists
        if git show-ref --verify --quiet refs/remotes/$REMOTE_BRANCH; then
          # Check if local is behind remote
          BEHIND=$(git rev-list --count HEAD..$REMOTE_BRANCH)
          AHEAD=$(git rev-list --count $REMOTE_BRANCH..HEAD)
          
          echo "Branch is $AHEAD commits ahead and $BEHIND commits behind $REMOTE_BRANCH"
          
          if [ "$BEHIND" -gt "0" ]; then
            echo "::warning::Branch $BRANCH_NAME is $BEHIND commits behind remote. Consider rebasing."
          fi
        else
          echo "Remote branch $REMOTE_BRANCH does not exist yet. This is a new branch."
        fi
        
    - name: Check PR sync status
      if: github.event_name == 'pull_request'
      run: |
        BASE_BRANCH=${{ github.base_ref }}
        HEAD_BRANCH=${{ github.head_ref }}
        
        echo "Checking if PR branch '$HEAD_BRANCH' is in sync with base '$BASE_BRANCH'"
        
        # Fetch base branch
        git fetch origin $BASE_BRANCH
        
        # Check commits behind base
        BEHIND=$(git rev-list --count HEAD..origin/$BASE_BRANCH)
        AHEAD=$(git rev-list --count origin/$BASE_BRANCH..HEAD)
        
        echo "PR is $AHEAD commits ahead and $BEHIND commits behind base branch"
        
        if [ "$BEHIND" -gt "0" ]; then
          echo "::warning::PR is $BEHIND commits behind base branch '$BASE_BRANCH'. Please update your branch."
          echo "::warning::Run: git fetch origin && git rebase origin/$BASE_BRANCH"
        fi
        
        # Check for potential merge conflicts
        git merge-tree $(git merge-base HEAD origin/$BASE_BRANCH) HEAD origin/$BASE_BRANCH > /tmp/merge-check
        if grep -q "<<<<<" /tmp/merge-check; then
          echo "::error::Potential merge conflicts detected. Please resolve before merging."
          exit 1
        else
          echo "âœ… No merge conflicts detected"
        fi
        
    - name: Report sync status
      if: always()
      run: |
        echo "### Branch Sync Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Branch synchronization check completed." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Tip**: Always run \`git fetch\` and \`git pull --rebase\` before pushing to avoid sync errors." >> $GITHUB_STEP_SUMMARY
